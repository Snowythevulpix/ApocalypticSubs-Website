<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApocalypticSubs - Player</title>
    <link rel="icon" href="../backend stuff/logo.png" type="image/x-icon">

    <meta property="og:title" content="ApocalypticSubs - Player">
    <meta property="og:description"
        content="We are dedicated to bringing you high-quality translations and fansubs of Seven Deadly Sins: Four Knights of the Apocalypse. Our group works hard to provide accurate translations and timely releases to help you enjoy anime in the best way possible.">
    <meta property="og:image" content="../backend stuff/logo.png">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
    <link href="/backend stuff/player.css" rel="stylesheet">

</head>
<header>


    <!-- Make sure the logo is also correctly referenced -->
    <nav>
        <img src="backend%20stuff/logo.png" alt="Logo">
        <a href="./">Home</a>
        <a href="./faq.html">FAQ</a>
        <a href="./player.html">Player</a>
        <!-- <a href="./s1player.html">Season 1 player</a> -->
        <a href="javascript:void(0);" onclick="toggleForm()">Report error</a>


        <!-- Hamburger Icon that toggles the menu visibility -->
        <div class="hamburger" onclick="toggleNavbar()">
            <div></div> <!-- Top bar -->
            <div></div> <!-- Middle bar -->
            <div></div> <!-- Bottom bar -->
        </div>

        <!-- Mobile Menu (hidden by default on desktop, shown when 'open' is added) -->
        <div class="menu">
            <a href="./">Home</a>
            <a href="./faq.html">FAQ</a>
            <a href="./player.html">Player</a>
            <!-- <a href="./s1player.html">Season 1 player</a> -->
            <a href="javascript:void(0);" onclick="toggleForm()">Report error</a>

        </div>
    </nav>

    </nav>
</header>

<body>
    <div class="container">
        <div class="episode-list" id="episodeListContainer">
            <h3>Episodes</h3>
            <ul id="episodeTitles"></ul>
        </div>

        <div class="player-container">
            <div id="episodeTitleDisplay"></div>
            <div id="player"></div>
            <div id="errorMessage"></div>
        </div>
    </div>

    <script>
        // Function to toggle the navbar visibility on mobile when the hamburger icon is clicked
        function toggleNavbar() {
            const nav = document.querySelector('nav'); // Select the navbar
            const menu = document.querySelector('.menu'); // Select the menu
            nav.classList.toggle('open'); // Toggle 'open' class on the navbar
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; // Toggle menu visibility
        }

        // Function to fetch releases.json from the specified path
        async function fetchReleases() {
            try {
                const response = await fetch('backend stuff/releases.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch releases.json');
                }
                const releases = await response.json();
                generateEpisodeList(releases);
                handleURLFragment(releases); // Handle URL fragment for direct loading
            } catch (error) {
                console.error(error);
                document.getElementById('errorMessage').textContent = "Error loading episode data.";
            }
        }

        // Function to generate episode list
        // Function to get the season number from the URL
        function getSeasonFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const season = urlParams.get('season');
            return season ? parseInt(season, 10) : 2; // Default to season 2 if not specified
        }

        // Function to redirect to ?season=2 if no season parameter is present
        function ensureSeasonParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('season')) {
                const newUrl = `${window.location.pathname}?season=2${window.location.hash}`;
                window.location.replace(newUrl);
            }
        }

        // Function to generate episode list
        function generateEpisodeList(releases) {
            document.getElementById('episodeTitleDisplay').textContent = "Select any episode to play.";
            const episodeTitlesContainer = document.getElementById('episodeTitles');
            const episodeListContainer = document.getElementById('episodeListContainer');

            const season = getSeasonFromURL(); // Get the season number from the URL

            // Filter episodes with canplayer !== "no", hidden !== true, and season === the specified season
            const validEpisodes = releases.filter(episode => {
                const isHidden = episode.hidden === "true" || episode.hidden === true;
                return episode.canplayer !== "no" && !isHidden && episode.season === season;
            });

            if (validEpisodes.length === 0) {
                episodeListContainer.style.display = 'none'; // Hide the episode list if no valid episodes
                return;
            }

            validEpisodes.forEach(episode => {
                const episodeElement = document.createElement('li');
                episodeElement.textContent = episode.episodetitle;

                // Add a click event listener with a cooldown
                episodeElement.addEventListener('click', () => {
                    // Disable the click event
                    episodeElement.style.pointerEvents = 'none';

                    // Load the episode
                    loadEpisode(episode);

                    // Re-enable the click event after 3 seconds
                    setTimeout(() => {
                        episodeElement.style.pointerEvents = 'auto';
                    }, 3000); // 3000 milliseconds = 3 seconds
                });

                episodeTitlesContainer.appendChild(episodeElement);
            });
        }

        // Initialize by ensuring the season parameter is present and fetching the releases data
        ensureSeasonParameter();
        fetchReleases();
    </script>

    <!-- Popup form container -->
    <div id="popupForm">
        <div class="popup-content">
            <span class="close-button" onclick="toggleForm()">Ã—</span>
            <h2>Report an Error</h2>
            <input type="text" id="name" placeholder="Enter your Discord username">
            <textarea id="error" placeholder="Describe the error"></textarea>
            <button id="submitButton">Submit</button>
        </div>
    </div>

    <script>
        // Function to toggle the visibility of the popup form
        function toggleForm() {
            const popup = document.getElementById('popupForm');
            popup.style.display = popup.style.display === 'none' || popup.style.display === '' ? 'flex' : 'none';
        }

        // Function to handle the form submission
        function reportError() {
            // Get user input values
            const name = document.getElementById('name').value;
            const error = document.getElementById('error').value;

            // Log the inputs to the console
            console.log('Report taken:');
            console.log(`Discord username: ${name}`);
            console.log(`Error reported: ${error}`);

            // Format the information for the server
            const formattedUsername = encodeURIComponent(name);
            const formattedError = encodeURIComponent(error);
            const serverUrl = `https://laptop-bhfr9fgd.tail34634e.ts.net/error/${formattedUsername}/${formattedError}`;

            // Log the formatted URL to the console (for testing)
            console.log(`Formatted URL: ${serverUrl}`);

            // Optionally, send the request to the server
            fetch(serverUrl, {
                method: 'GET',
            })
                .then(response => response.json())
                .then(data => console.log(data))
                .catch(error => console.error('Error sending report:', error));

            // Hide the popup form after submission
            document.getElementById('popupForm').style.display = 'none';
        }

        // Add event listener to the submit button
        window.onload = function () {
            document.getElementById('submitButton').addEventListener('click', reportError);
        };

    </script>

</body>

</html>