<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApocalypticSubs - Player</title>
    <link rel="icon" href="../backend stuff/logo.png" type="image/x-icon">

    <meta property="og:title" content="ApocalypticSubs - Player">
    <meta property="og:description"
        content="We are dedicated to bringing you high-quality translations and fansubs of Seven Deadly Sins: Four Knights of the Apocalypse. Our group works hard to provide accurate translations and timely releases to help you enjoy anime in the best way possible.">
    <meta property="og:image" content="../backend stuff/logo.png">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
    <style>
        body {
            background-image: url('/backend stuff/pagemedia/mainbg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            font-family: 'Pirata One', sans-serif;
            /* Change to Pirata One */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;

            /* Allows stacking the nav and main content */
        }

        .container {
            display: flex;
            width: 80%;
            height: calc(100vh - 60px);
            /* Ensure container height accounts for the fixed nav bar */
            margin-top: 60px;
            /* Offset for the nav bar */
        }


        .episode-list {
            margin-top: 20px;
            margin-bottom: 22.5px;
            width: 20%;
            /* Episode list takes up 25% of the width */
            padding: 10px;
            background-color: #390000;
            border-radius: 8px;
            overflow-y: auto;
            height: 80%;
            box-sizing: border-box;
            text-shadow:
                1px 1px 2px rgba(255, 0, 0, 0.5),
                /* Black shadow for top-left */
                -1px -1px 2px rgba(255, 0, 0, 0.5),
                /* Black shadow for bottom-right */
                1px -1px 2px rgba(255, 0, 0, 0.5),
                /* Black shadow for bottom-left */
                -1px 1px 2px rgba(255, 0, 0, 0.5);
            /* Black shadow for top-right */
        }


        .episode-list h3 {
            margin-top: 0;
        }

        .episode-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .episode-list li {
            background-color: rgb(114, 6, 6);
            margin: 10px 0;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 4px;
        }

        .episode-list li:hover {
            background-color: rgb(255, 0, 0);
        }

        /* Regular desktop version: Player container */
        .player-container {
            margin-top: 20px;
            width: 75%;
            /* Takes up 74% of the screen width */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            /* Align items from the top */
            height: 100%;
            padding-left: 20px;
            /* Space between the player and the side */
            box-sizing: border-box;
        }



        /* Container for both the episode title and video player */
        .video-and-title-container {
            width: 100%;
            /* Ensures it takes up full width of its parent container */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            /* Align items from the top */
            box-sizing: border-box;
        }


        /* Regular desktop version: Video */
        video {
            height: 99.1%;
            /* Ensure the video occupies most of the available height */
            object-fit: contain;
            border: 4mm ridge rgb(135, 0, 0);
            /* Same border style as the title */
            width: 100%;
            /* Full width of the container */
            box-sizing: border-box;
            /* Ensure padding doesn't break the layout */
        }


        /* Remove border in fullscreen mode */
        video:fullscreen {
            border: none;
        }



        /* Regular desktop version: Episode Title Display */
        #episodeTitleDisplay {
            font-size: 20px;
            word-wrap: break-word;
            overflow: visible;
            text-align: center;
            background-color: #290202b9;
            /* Slight transparency */
            padding: 10px;
            border: 4mm ridge rgb(135, 0, 0);
            /* Same border style as video */
            text-shadow:
                1px 1px 2px rgba(0, 0, 0, 0.5),
                -1px -1px 2px rgba(0, 0, 0, 0.5),
                1px -1px 2px rgba(0, 0, 0, 0.5),
                -1px 1px 2px rgba(0, 0, 0, 0.5);
            width: 100%;
            /* Full width of the container */
            box-sizing: border-box;
        }




        /* Regular desktop version: Error message */
        #errorMessage {
            color: red;
            font-size: 16px;
            margin-top: 10px;
        }


        /* General Navbar Styles */
        nav {
            display: flex;
            justify-content: center;
            /* Align items horizontally */
            align-items: center;
            /* Center items vertically */
            width: 100%;
            /* Full width */
            background-color: black;
            /* Black background */
            position: fixed;
            /* Fix navbar at top */
            top: 0;
            /* Position at the top */
            left: 0;
            /* Position at the left */
            z-index: 1000;
            /* Ensure it is on top */
            padding: 0 20px;
            /* Horizontal padding for spacing */
            box-sizing: border-box;
            /* Include padding in width calculation */
            height: 80px;
            /* Default height */
            border-bottom: 5px solid red;
            /* Bottom border */
            transition: height 0.3s ease;
            /* Smooth height transition */
        }

        nav img {
            position: absolute;
            top: 10px;
            /* Adjust based on desired vertical position */
            left: 20px;
            /* Adjust based on desired horizontal position */
            height: 50px;
            /* Keep your desired logo height */
            object-fit: contain;
        }

        .container {
            display: flex;
            width: 80%;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }



        /* Navbar Links (desktop) */
        nav a {
            color: white;
            /* White text color */
            text-decoration: none;
            /* Remove underlines */
            margin: 0 15px;
            /* Space between links */
            font-weight: bold;
            /* Bold text */
            padding: 10px 15px;
            /* Padding around text */
            transition: background-color 0.3s, color 0.3s;
            /* Smooth transition on hover */
            background-color: black;
            border: 5px solid #bd0d07;
            padding: 10px 20px;
            border-radius: 10px;

        }


        /* Navbar link hover effect */
        nav a:hover {
            background-color: red;
            /* Red background on hover */
            color: black;
            /* Black text on hover */
        }

        .menu {
            display: none;
            /* Hide the menu by default */
        }

        @media (max-width: 768px) {

            /* Hide navbar links and buttons in mobile mode */
            nav a {
                display: none;
            }

            .menu {
                display: none;
                /* Ensure the mobile menu stays hidden */
            }

            .hamburger {
                display: block;
                /* Only show the hamburger icon */
            }
        }

        @media (max-width: 768px) {

            nav.open .hamburger {
                background-color: transparent;
                /* Hide the main bar */
            }

            nav.open .hamburger:before {
                transform: rotate(45deg);
                top: 0;
            }

            nav.open .hamburger:after {
                transform: rotate(-45deg);
                top: 0;
            }

            /* Mobile-specific Styles */
            nav {
                padding: 0 10px;
                /* Less padding for mobile */
                height: 60px;
                /* Keep navbar height the same */
            }

            .hamburger-wrapper {
                position: relative;
                /* Allows precise positioning for the overlay */
                display: inline-block;
                /* Adjusts to fit the content */
            }

            .hamburger {
                cursor: pointer;
                position: relative;
            }

            .hamburger div {
                width: 30px;
                /* Dash width */
                height: 3px;
                /* Dash thickness */
                background-color: black;
                /* Dash color */
                margin: 4px 0;
                /* Spacing between dashes */
            }

            .hamburger-overlay {
                position: absolute;
                top: -5px;
                /* Adjust to center the overlay */
                left: -5px;
                width: 40px;
                /* Clickable area width */
                height: 40px;
                /* Clickable area height */
                background-color: transparent;
                /* Invisible area */
                cursor: pointer;
                /* Ensures it's clickable */
                z-index: 1;
                /* Ensures it sits above the hamburger */
            }


            /* Show hamburger icon on mobile */
            .hamburger {
                display: block;
                width: 30px;
                height: 3px;
                background-color: white;
                position: relative;
                cursor: pointer;
                z-index: 1001;
            }

            /* Hamburger icon bars (before and after) */
            .hamburger:before,
            .hamburger:after {
                content: '';
                position: absolute;
                width: 30px;
                height: 3px;
                background-color: white;
                left: 0;
                transition: 0.3s;
            }

            .hamburger:before {
                top: -10px;
            }

            .hamburger:after {
                top: 10px;
            }

            /* Toggle animation when the hamburger is open */
            nav.open .hamburger:before {
                transform: rotate(45deg);
                top: 0;
            }

            nav.open .hamburger:after {
                transform: rotate(-45deg);
                top: 0;
            }

            /* Mobile menu visibility toggle */
            nav.open .menu {
                display: block !important;
                /* Ensure this is properly showing the menu */
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                background-color: black;
                opacity: 0.95;
                z-index: 999;
                padding-top: 60px;
                /* Add space for the navbar */
                text-align: center;
            }

            /* Mobile menu links */
            nav.open a {
                display: block;
                /* Display links as block elements */
                margin: 15px 0;
                /* Vertical spacing */
                color: white;
                /* White text color */
                font-size: 20px;
                /* Larger font size for mobile */
                padding: 10px 0;
                /* Padding for clickability */
            }



            /* Main container for mobile */
            .container {
                display: flex;
                flex-direction: column;
                /* Stack content vertically */
                width: 100%;
                /* Full width for mobile */
                height: calc(100vh - 60px);
                /* Full height minus navbar height */
                margin-top: 60px;
                /* Account for navbar */
                box-sizing: border-box;
                padding: 10px;
                /* Padding around the content */
            }

            /* Episode list moved to the bottom */
            .episode-list {
                width: 100%;
                /* Full width */
                margin-top: 10px;
                /* Space between player and episode list */
                height: auto;
                /* Let the list grow as needed */
                max-height: 50vh;
                /* Limit height to 50% of the screen */
                overflow-y: auto;
                /* Allow scrolling if list is long */
                padding: 10px;
                background-color: #390000;
                border-radius: 8px;
                box-sizing: border-box;
                text-shadow:
                    1px 1px 2px rgba(255, 0, 0, 0.5),
                    -1px -1px 2px rgba(255, 0, 0, 0.5),
                    1px -1px 2px rgba(255, 0, 0, 0.5),
                    -1px 1px 2px rgba(255, 0, 0, 0.5);
            }

            /* Player container (video and title display) at the top */
            .player-container {
                width: 100%;
                /* Full width for player container */
                padding-left: 0;
                /* Remove left padding */
                margin-top: 10px;
                /* Space between list and player */
                box-sizing: border-box;
            }

            /* Title display in mobile */
            #episodeTitleDisplay {
                font-size: 18px;
                /* Smaller text size */
                padding: 5px;
                /* Adjust padding for mobile */
                width: 100%;
                /* Full width on mobile */
                box-sizing: border-box;
                background-color: #290202b9;
                /* Slight transparency */
                border: 4mm ridge rgb(135, 0, 0);
                /* Same border style as video */
                text-shadow:
                    1px 1px 2px rgba(0, 0, 0, 0.5),
                    -1px -1px 2px rgba(0, 0, 0, 0.5),
                    1px -1px 2px rgba(0, 0, 0, 0.5),
                    -1px 1px 2px rgba(0, 0, 0, 0.5);
            }

            /* Video Player in mobile */
            video {
                width: 100%;
                /* Full width of the container */
                height: auto;
                /* Adjust height automatically */
                max-height: 60vh;
                /* Limit video height to 60% of the viewport */
                object-fit: contain;
                border: 4mm ridge rgb(135, 0, 0);
                /* Same border style as title */
                margin-bottom: 10px;
                /* Add space between video and subtitle button */
                box-sizing: border-box;
            }

            /* Error message on mobile */
            #errorMessage {
                font-size: 14px;
                /* Slightly smaller error message font */
                margin-top: 5px;
                width: 100%;
                /* Full width on mobile */
                box-sizing: border-box;
            }
        }
    </style>
</head>
<header>


    <!-- Make sure the logo is also correctly referenced -->
    <nav>
        <img src="backend%20stuff/logo.png" alt="Logo">
        <a href="./">Home</a>
        <a href="./faq.html">FAQ</a>
        <a href="./releases.html">Releases</a>
        <a href="./player.html">Player</a>

        <!-- Hamburger Icon that toggles the menu visibility -->
        <div class="hamburger" onclick="toggleNavbar()">
            <div></div> <!-- Top bar -->
            <div></div> <!-- Middle bar -->
            <div></div> <!-- Bottom bar -->
        </div>

        <!-- Mobile Menu (hidden by default on desktop, shown when 'open' is added) -->
        <div class="menu">
            <a href="./">Home</a>
            <a href="./faq.html">FAQ</a>
            <a href="./releases.html">Releases</a>
            <a href="./player.html">Player</a>
        </div>
    </nav>

    </nav>
</header>

<body>
    <div class="container">
        <div class="episode-list" id="episodeListContainer">
            <h3>Episodes</h3>
            <ul id="episodeTitles"></ul>
        </div>

        <div class="player-container">
            <div id="episodeTitleDisplay"></div>
            <div id="player"></div>
            <div id="errorMessage"></div>
        </div>
    </div>

    <script>
        // Function to toggle the navbar visibility on mobile when the hamburger icon is clicked
        function toggleNavbar() {
            const nav = document.querySelector('nav'); // Select the navbar
            const menu = document.querySelector('.menu'); // Select the menu
            nav.classList.toggle('open'); // Toggle 'open' class on the navbar
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; // Toggle menu visibility
        }

        // Function to fetch releases.json from the specified path
        async function fetchReleases() {
            try {
                const response = await fetch('backend stuff/releases.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch releases.json');
                }
                const releases = await response.json();
                generateEpisodeList(releases);
                handleURLFragment(releases); // Handle URL fragment for direct loading
            } catch (error) {
                console.error(error);
                document.getElementById('errorMessage').textContent = "Error loading episode data.";
            }
        }

        // Function to generate episode list
        function generateEpisodeList(releases) {
            document.getElementById('episodeTitleDisplay').textContent = "Select any episode to play.";
            const episodeTitlesContainer = document.getElementById('episodeTitles');
            const episodeListContainer = document.getElementById('episodeListContainer');

            // Filter episodes with canplayer !== "no" and hidden !== true
            const validEpisodes = releases.filter(episode => {
                console.log(episode); // Log each episode to see its properties
                // Convert the 'hidden' value to a boolean (checking for "true" string or false value)
                const isHidden = episode.hidden === "true" || episode.hidden === true;
                return episode.canplayer !== "no" && !isHidden;
            });

            if (validEpisodes.length === 0) {
                episodeListContainer.style.display = 'none'; // Hide the episode list if no valid episodes
                return;
            }

            validEpisodes.forEach(episode => {
                const episodeElement = document.createElement('li');
                episodeElement.textContent = episode.episodetitle;
                episodeElement.addEventListener('click', () => loadEpisode(episode));
                episodeTitlesContainer.appendChild(episodeElement);
            });
        }

        // Function to fetch the URL for an episode from localhost
        async function fetchEpisodeUrl(episodeId) {
            try {
                const response = await fetch(`https://laptop-bhfr9fgd.tail34634e.ts.net/geturl/${episodeId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch episode URL');
                }
                const data = await response.json();
                return data.url; // Return the URL from the API response
            } catch (error) {
                console.error('Error fetching episode URL:', error);
                return null; // Return null if the request fails
            }
        }

        // Function to load the selected episode
        async function loadEpisode(episode) {
            document.getElementById('episodeTitleDisplay').textContent = `${episode.displaytexten} - ${episode.episodetitle}`;
            const playerContainer = document.getElementById('player');
            const episodeTitleDisplay = document.getElementById('episodeTitleDisplay');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.textContent = ''; // Clear previous error
            episodeTitleDisplay.textContent = `${episode.displaytexten} - ${episode.episodetitle}`;

            // Print the episode ID to the console when it's loaded
            console.log(`Loaded episode ID: ${episode.id}`);

            if (episode.canplayer === "no") {
                errorMessage.textContent = "This release isn't player compatible.";
                playerContainer.innerHTML = ''; // Clear the player if not compatible
                return;
            }

            // Clear the player container
            playerContainer.innerHTML = '';

            // Create video element
            const video = document.createElement('video');
            video.allow = "autoplay";
            video.controls = true;

            // Set poster image
            video.poster = episode.image || './backend stuff/releasephotos/placeholder.png';

            // Add subtitles (track element)
            if (episode.rawcaptions) {
                const subtitleTrack = document.createElement('track');
                subtitleTrack.kind = 'subtitles'; // Can also be 'captions'
                subtitleTrack.label = 'Japanese'; // Subtitle track label
                subtitleTrack.srclang = 'jpn'; // Language of the subtitles (e.g., 'en' for English)
                subtitleTrack.src = episode.rawcaptions; // URL of the subtitle file
                subtitleTrack.default = true; // Enable by default
                video.appendChild(subtitleTrack);
            } else {
                console.warn('No subtitles available for this episode!');
            }

            // Fetch the video URL from the API
            const videoUrl = await fetchEpisodeUrl(episode.id);
            if (videoUrl) {
                video.src = videoUrl; // Update the video source with the URL from the API
                // Append video to the player container
                playerContainer.appendChild(video);
            } else {
                errorMessage.textContent = 'Failed to load video URL.';
            }
        }

        // Function to handle URL fragment and load the episode dynamically
        function handleURLFragment(releases) {
            const fragment = window.location.hash.substring(1); // Get the fragment without '#'
            if (!fragment) return; // Exit if no fragment present

            const matchedEpisode = releases.find(
                episode => episode.id === fragment // Assuming 'id' in releases.json matches the fragment
            );

            if (matchedEpisode) {
                loadEpisode(matchedEpisode); // Load the matching episode
            } else {
                console.warn('No matching episode found for the provided fragment:', fragment);
            }
        }

        // Initialize by fetching the releases data
        fetchReleases();

    </script>

</body>

</html>